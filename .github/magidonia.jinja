{%- set default_system_message = 'First draft your thinking process (inner monologue) until you arrive at a response. Format your response using Markdown, and use LaTeX for any mathematical equations. Write both your thoughts and the response in the same language as the input.\n\nYour thinking process must follow the template below:[THINK]Your thoughts or/and draft, like working through an exercise on scratch paper. Be as casual and as long as you want until you are confident to generate the response. Use the same language as the input.[/THINK]Here, provide a self-contained response.' %}
 
{{- bos_token }}
 
{#- Extract system message if present -#}
{%- if messages[0]['role'] == 'system' %}
    {%- if messages[0]['content'] is string %}
        {%- set raw_system_message = messages[0]['content'] %}
    {%- else %}
        {%- set raw_system_message = messages[0]['content'][0]['text'] %}
    {%- endif %}
    {%- set loop_messages = messages[1:] %}
{%- else %}
    {%- set raw_system_message = "" %}
    {%- set loop_messages = messages %}
{%- endif %}
 
{#- Detect THINK flag by searching for exact phrase "/think" -#}
{%- if "/think" in raw_system_message %}
    {%- set THINK = True %}
{%- else %}
    {%- set THINK = False %}
{%- endif %}
 
{#- Apply logic depending on THINK flag -#}
{%- if THINK %}
    {%- if raw_system_message|length > 0 %}
        {%- set system_message = default_system_message + "\n\n" + raw_system_message %}
    {%- else %}
        {%- set system_message = default_system_message %}
    {%- endif %}
    {{- '[SYSTEM_PROMPT]' + system_message + '[/SYSTEM_PROMPT]' }}
{%- else %}
    {%- if raw_system_message|length > 0 %}
        {{- '[SYSTEM_PROMPT]' + raw_system_message + '[/SYSTEM_PROMPT]' }}
    {%- endif %}
{%- endif %}
 
 
{#- Tool description appended ONLY to last user message. Edits made by Unsloth #}
{%- set tools_description = "" %}
{%- set has_tools = false %}
 
{%- if tools is defined and tools is not none and tools|length > 0 %}
    {%- set has_tools = true %}
    {%- set tools_description = "[AVAILABLE_TOOLS]" + (tools | tojson) + "[/AVAILABLE_TOOLS]" %}
    {{- tools_description }}
{%- endif %}
 
{%- for message in loop_messages %}
    {%- if message['role'] == 'user' %}
 
        {%- if message['content'] is string %}
            {{- '[INST]' + message['content'] + '[/INST]' }}
        {%- else %}
            {{- '[INST]' }}
            {%- for block in message['content'] %}
                {%- if block['type'] == 'text' %}
                    {%- if block['text'] is defined %}
                        {{- block['text'] }}
                    {%- else %}
                        {{- block['content'] }}
                    {%- endif %}
                {%- elif block['type'] in ['image', 'image_url'] %}
                    {{- '[IMG]' }}
                {%- else %}
                    {{- raise_exception('Only text and image blocks are supported in message content!') }}
                {%- endif %}
            {%- endfor %}
            {{- '[/INST]' }}
        {%- endif %}
 
    {%- elif message['role'] == 'system' %}
        {%- if message['content'] is string %}
            {{- '[SYSTEM_PROMPT]' + message['content'] + '[/SYSTEM_PROMPT]' }}
        {%- else %}
            {{- '[SYSTEM_PROMPT]' + message['content'][0]['text'] + '[/SYSTEM_PROMPT]' }}
        {%- endif %}
 
    {%- elif message['role'] == 'assistant' %}
        {%- if message['content'] is string %}
            {{- message['content'] }}
        {%- elif message['content'] is iterable  %}
            {{- message['content'][0]['text'] }}
        {%- endif %}
 
        {%- if message['tool_calls'] is defined and message['tool_calls'] is not none %}
            {%- for tool in message['tool_calls'] %}
                {%- set arguments = tool['function']['arguments'] %}
                {%- if arguments is not string %}
                    {%- set arguments = arguments|tojson %}
                {%- endif %}
                {{- "[TOOL_CALLS]" + tool['function']['name'] + "[ARGS]" + arguments }}
            {%- endfor %}
        {%- endif %}
 
        {{- eos_token }}
 
    {%- elif message["role"] == "tool_results" or message["role"] == "tool" %}
        {%- if message.content is defined and message.content.content is defined %}
            {%- set content = message.content.content %}
        {%- else %}
            {%- set content = message.content %}
        {%- endif %}
        {{- "[TOOL_RESULTS]" + content|string + "[/TOOL_RESULTS]" }}
 
    {%- else %}
        {{- raise_exception('Only user, system, assistant and tool roles are supported!') }}
    {%- endif %}
{%- endfor %}