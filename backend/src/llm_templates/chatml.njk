{# ChatML format for MessageContext #}
<|im_start|>system
{% if preSystemPrompt %}{{ preSystemPrompt }}

{% endif %}
{% if summary %}## SCENE SUMMARY
{{ summary }}

{% endif %}
{% if lore and lore.length > 0 %}## LORE
{% for entry in lore %}{{ entry }}

{% endfor %}
{% endif %}
{% if memories and memories.length > 0 %}## MEMORIES
{% for memory in memories %}{{ memory }}

{% endfor %}
{% endif %}
{% if finalSystemPrompt %}{{ finalSystemPrompt }}

{% endif %}
{% if jsonSpec %}## OUTPUT FORMAT
{% if jsonSpec.mode == 'schema' and jsonSpec.schema %}Respond with JSON matching this schema:
```json
{{ jsonSpec.schema if jsonSpec.schema is string else (jsonSpec.schema | dump(2)) }}
```
{% elif jsonSpec.mode == 'object' and jsonSpec.example %}Respond with JSON matching this structure:
```json
{{ jsonSpec.example | dump(2) }}
```
{% endif %}
{% endif %}<|im_end|>
{% if chatHistory and chatHistory.length > 0 %}{% for msg in chatHistory %}{% if loop.index0 % 2 == 0 %}<|im_start|>user
{{ msg }}<|im_end|>
{% else %}<|im_start|>assistant
{{ msg }}<|im_end|>
{% endif %}{% endfor %}{% endif %}
{% if currentRoundMessages and currentRoundMessages.length > 0 %}{% for msg in currentRoundMessages %}<|im_start|>assistant
{{ msg }}<|im_end|>
{% endfor %}{% endif %}
{% if userInput %}<|im_start|>user
{{ userInput }}<|im_end|>
{% endif %}
<|im_start|>assistant
